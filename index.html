<script>
  const coin = document.getElementById('coin');
  const coinSlot = document.getElementById('coinSlot');
  const coinSlotArea = document.getElementById('coinSlotArea');
  const slotReel = document.getElementById('slotReel');
  const lever = document.getElementById('lever');
  const leverContainer = document.getElementById('leverContainer');
  const noBtn = document.getElementById('noBtn');
  const finalScreen = document.getElementById('finalScreen');
  const addToCalendarBtn = document.getElementById('addToCalendarBtn');
  const restartBtn = document.getElementById('restartBtn');

  // IMPORTANT: stop native HTML dragging interfering with our custom drag
  coin.removeAttribute('draggable');
  coin.addEventListener('dragstart', (e) => e.preventDefault());

  // Simple sound effects (tiny base64-free via WebAudio)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioCtx ? new AudioCtx() : null;

  function beep(freq = 440, duration = 0.08, type = 'sine', gain = 0.04) {
    if (!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(gain, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + duration);
  }

  function chime() {
    beep(659, 0.06, 'sine', 0.05);
    setTimeout(() => beep(784, 0.06, 'sine', 0.05), 70);
    setTimeout(() => beep(988, 0.08, 'sine', 0.05), 140);
  }

  function sadBuzz() {
    beep(180, 0.12, 'square', 0.03);
    setTimeout(() => beep(140, 0.12, 'square', 0.03), 110);
  }

  let isDragging = false;
  let coinInserted = false;
  let currentTurn = 0;

  const turns = [
    { icon: 'calendar', text: '14th February 2025' },
    { icon: 'ğŸ½ï¸', text: '6pm - Dinner at Cala' },
    { icon: 'ğŸ ', text: "Followed by a show and tell at my place (Dw I'll have wine for you)" },
    { icon: 'ğŸ§±', text: 'Or a lil lego date' },
    { icon: 'ğŸ›‘', text: 'You want more? greedy lil shit' },
  ];

  // Calendar details (for .ics)
  const dateStart = new Date('2025-02-14T18:00:00');
  const dateEnd = new Date('2025-02-14T21:00:00');
  const eventTitle = "Valentine's Date ğŸ’˜";
  const eventLocation = 'Cala';
  const eventDescription = "Dinner at 6pm, then vibes.\n\nMade with ğŸ¥° by Anunay.";

  // Coin drag and drop
  coin.addEventListener('mousedown', startDrag);
  coin.addEventListener('touchstart', startDrag, { passive: false });
  document.addEventListener('mousemove', drag);
  document.addEventListener('touchmove', drag, { passive: false });
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('touchend', endDrag);

  function startDrag(e) {
    if (coinInserted) return;
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

    isDragging = true;
    coin.classList.add('dragging');
  }

  function drag(e) {
    if (!isDragging || coinInserted) return;
    e.preventDefault();

    const touch = e.touches ? e.touches[0] : e;
    const slotRect = coinSlot.getBoundingClientRect();

    coin.style.position = 'fixed';
    coin.style.left = touch.clientX - 30 + 'px';
    coin.style.top = touch.clientY - 30 + 'px';

    const distance = Math.sqrt(
      Math.pow(touch.clientX - (slotRect.left + slotRect.width / 2), 2) +
      Math.pow(touch.clientY - (slotRect.top + slotRect.height / 2), 2)
    );

    if (distance < 80) coinSlot.classList.add('glow');
    else coinSlot.classList.remove('glow');
  }

  function endDrag(e) {
    if (!isDragging || coinInserted) return;
    isDragging = false;
    coin.classList.remove('dragging');

    const touch = e.changedTouches ? e.changedTouches[0] : e;
    const slotRect = coinSlot.getBoundingClientRect();

    const distance = Math.sqrt(
      Math.pow(touch.clientX - (slotRect.left + slotRect.width / 2), 2) +
      Math.pow(touch.clientY - (slotRect.top + slotRect.height / 2), 2)
    );

    if (distance < 80) insertCoin();
    else resetCoinPosition();
  }

  function resetCoinPosition() {
    coin.style.position = 'relative';
    coin.style.left = '0';
    coin.style.top = '0';
    coinSlot.classList.remove('glow');
  }

  function insertCoin() {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    chime();

    coinInserted = true;
    coin.classList.add('inserted');
    coinSlot.classList.remove('glow');
    createEmojis(3);

    setTimeout(() => {
      coinSlotArea.style.display = 'none';
      leverContainer.style.display = 'block';
    }, 600);
  }

  // Lever pull
  lever.addEventListener('click', pullLever);

  function pullLever() {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    beep(220, 0.05, 'triangle', 0.04);

    if (currentTurn >= turns.length) return;

    lever.classList.add('pulling');
    createEmojis(2);

    setTimeout(() => {
      lever.classList.remove('pulling');
      spinSlot();
    }, 200);
  }

  function spinSlot() {
    beep(520, 0.03, 'sine', 0.02);

    const symbols = ['ğŸ¥°', 'â¤ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’–'];
    slotReel.classList.add('spinning');

    let spinCount = 0;
    const spinInterval = setInterval(() => {
      slotReel.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      spinCount++;

      if (spinCount > 15) {
        clearInterval(spinInterval);
        slotReel.classList.remove('spinning');
        showCard();
      }
    }, 100);
  }

  function showCard() {
    beep(880, 0.06, 'sine', 0.05);

    const turn = turns[currentTurn];
    slotReel.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'card show';

    if (turn.icon === 'calendar') {
      card.innerHTML = `
        <div class="calendar">
          <div class="calendar-header">FEB</div>
          <div class="calendar-date">14</div>
        </div>
        <div class="card-text">${turn.text}</div>
      `;
    } else {
      card.innerHTML = `
        <div class="card-icon">${turn.icon}</div>
        <div class="card-text">${turn.text}</div>
      `;
    }

    slotReel.appendChild(card);

    setTimeout(() => {
      card.classList.add('dispense');
      setTimeout(() => {
        slotReel.innerHTML = '';
        currentTurn++;

        if (currentTurn >= turns.length) endSequence();
      }, 600);
    }, 2500);
  }

  function endSequence() {
    leverContainer.style.display = 'none';
    finalScreen.classList.add('show');

    heartConfetti(40);

    if (navigator.vibrate) navigator.vibrate([40, 40, 60]);

    chime();
    setTimeout(chime, 220);
  }

  function heartConfetti(count = 30) {
    const hearts = ['ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’•', 'â¤ï¸'];
    for (let i = 0; i < count; i++) {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'confetti';
        el.textContent = hearts[Math.floor(Math.random() * hearts.length)];
        el.style.left = Math.random() * window.innerWidth + 'px';
        el.style.transform = `translateY(0) rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1900);
      }, i * 20);
    }
  }

  function createEmojis(count) {
    beep(740, 0.02, 'sine', 0.015);

    for (let i = 0; i < count; i++) {
      setTimeout(() => {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-float';
        emoji.textContent = 'ğŸ¥°';
        emoji.style.left = Math.random() * window.innerWidth + 'px';
        emoji.style.top = window.innerHeight - 100 + 'px';
        document.body.appendChild(emoji);

        setTimeout(() => emoji.remove(), 2000);
      }, i * 200);
    }
  }

  // Add to calendar (ICS download)
  addToCalendarBtn.addEventListener('click', () => {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    beep(988, 0.06, 'sine', 0.05);

    const ics = buildICS();
    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'valentines-date.ics';
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });

  restartBtn.addEventListener('click', () => {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    beep(440, 0.05, 'triangle', 0.04);

    currentTurn = 0;
    coinInserted = false;
    isDragging = false;

    finalScreen.classList.remove('show');
    slotReel.innerHTML = '';
    coinSlotArea.style.display = 'block';
    leverContainer.style.display = 'none';

    coin.classList.remove('inserted');
    resetCoinPosition();

    noClicks = 0;
    noBtn.textContent = 'Click here if not :(';
    noBtn.style.transform = 'translate(0, 0)';
    coinSlot.classList.remove('glow');

    heartConfetti(18);
  });

  function pad2(n) {
    return String(n).padStart(2, '0');
  }

  function toICSDate(d) {
    const yyyy = d.getUTCFullYear();
    const mm = pad2(d.getUTCMonth() + 1);
    const dd = pad2(d.getUTCDate());
    const hh = pad2(d.getUTCHours());
    const mi = pad2(d.getUTCMinutes());
    const ss = pad2(d.getUTCSeconds());
    return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
  }

  function escapeICS(text) {
    return String(text)
      .replace(/\\/g, '\\\\')
      .replace(/\n/g, '\\n')
      .replace(/,/g, '\\,')
      .replace(/;/g, '\\;');
  }

  function buildICS() {
    const dtStamp = toICSDate(new Date());
    const dtStart = toICSDate(dateStart);
    const dtEnd = toICSDate(dateEnd);
    const uid = `valentines-${Date.now()}@anunay`;

    return [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Anunay//Valentine Vending Machine//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${dtStamp}`,
      `DTSTART:${dtStart}`,
      `DTEND:${dtEnd}`,
      `SUMMARY:${escapeICS(eventTitle)}`,
      `LOCATION:${escapeICS(eventLocation)}`,
      `DESCRIPTION:${escapeICS(eventDescription)}`,
      'END:VEVENT',
      'END:VCALENDAR',
    ].join('\r\n');
  }

  // NO button: playful rejection flow
  const noLines = [
    "Awww okay ğŸ˜­",
    "Waitâ€¦ are you sure? ğŸ¥º",
    "Last chanceâ€¦ ğŸ˜”",
    "Okay Iâ€™ll stop (lying) ğŸ˜¤",
    "Fine. Iâ€™ll just go cry in HD ğŸ˜­ğŸ“º",
  ];

  let noClicks = 0;

  noBtn.addEventListener('click', () => {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    sadBuzz();

    noBtn.textContent = noLines[Math.min(noClicks, noLines.length - 1)];
    noClicks++;

    const dx = (Math.random() * 2 - 1) * 120;
    const dy = (Math.random() * 2 - 1) * 50;
    noBtn.style.transform = `translate(${dx}px, ${dy}px)`;

    for (let i = 0; i < 2; i++) {
      setTimeout(() => {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-float';
        emoji.textContent = 'ğŸ¥º';
        emoji.style.left = Math.random() * window.innerWidth + 'px';
        emoji.style.top = window.innerHeight - 100 + 'px';
        document.body.appendChild(emoji);
        setTimeout(() => emoji.remove(), 2000);
      }, i * 150);
    }

    if (noClicks >= 4) {
      noBtn.textContent = "Ok fine. Put the coin in ğŸ˜Œ";
      coinSlot.classList.add('glow');
    }
  });
</script>
